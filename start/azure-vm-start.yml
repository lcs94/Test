steps:
- script: |
    az login --service-principal -u 0cd2a780-3598-4328-8db8-8b7ba273e024 -p 7wj8Q~ZoQE19B3yHSRlA9XoXzu63nIHjCWuI8a1Z --tenant c86959ed-45e5-47f5-8ef5-308ca79916fc
    cd $(Agent.BuildDirectory)
  displayName: 'Azure Login'

- powershell: |
    echo "TESTIMG: $env:TESTIMG"
    echo "ISSUE: $env:ISSUE"
    echo "TEST: $env:TEST"
    $jsonOutput = az vm list --show-details --query "[?powerState=='VM deallocated']" | Out-String | ConvertFrom-Json
    $Agent = $jsonOutput | Where-Object { $_.name -match "Agent" } | Select-Object -ExpandProperty name
    $dkns = $jsonOutput | Where-Object { $_.name -match "dkns" } | Select-Object -ExpandProperty name

    az vm start --name $Agent --resource-group Automated_Test
    az vm start --name $dkns --resource-group Automated_Test

    echo "가상 머신 $Agent 시작됨."
    echo "가상 머신 $dkns 시작됨."
  displayName: 'Azure Start VM'

- powershell: |
    $AgentIP = az vm show -d -g Automated_Test -n $Agent --query publicIps -o tsv
    psexec -accepteula $AgentIP -u Tester -p Tester1234@! -i 2 -h cmd /C start /MIN C:/test2.bat $TESTIMG $ISSUE $TEST
  displayName: 'Run Test(PsExec)'
  workingDirectory: $(Build.SourcesDirectory)/start