steps:
- script: |
    az login --service-principal -u 0cd2a780-3598-4328-8db8-8b7ba273e024 -p 7wj8Q~ZoQE19B3yHSRlA9XoXzu63nIHjCWuI8a1Z --tenant c86959ed-45e5-47f5-8ef5-308ca79916fc
    cd $(Agent.BuildDirectory)
  displayName: 'Azure Login'

- powershell: |
    $jsonOutput = az vm list --show-details --query "[?powerState=='VM deallocated']" | Out-String | ConvertFrom-Json
    $Agent = $jsonOutput | Where-Object { $_.name -match "Agent" } | Select-Object -ExpandProperty name
    $dkns = $jsonOutput | Where-Object { $_.name -match "dkns" } | Select-Object -ExpandProperty name
    
    Set-Variable -Name Agent -Value $Agent -Scope Global
    Set-Variable -Name dkns -Value $dkns -Scope Global
    
    Write-Host "Agent: $Agent"
    Write-Host "dkns: $dkns"

    echo "Agent: $env:Agent"
    echo "dkns: $env:dkns"

    if ($Agent -ne "" -and $dkns -ne "") {
        echo "Agent: $env:Agent"
        echo "dkns: $env:dkns"
        az vm start --name "$env:dkns" --resource-group Automated_Test
        az vm start --name "$env:Agent" --resource-group Automated_Test
    } else {
        Write-Host "Agent or dkns is empty. Skipping VM start."
    }
  displayName: 'Azure Start VM'
  workingDirectory: $(Build.SourcesDirectory)/start