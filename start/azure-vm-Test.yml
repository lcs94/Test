steps:
- script: |
    az login --service-principal -u 0cd2a780-3598-4328-8db8-8b7ba273e024 -p 7wj8Q~ZoQE19B3yHSRlA9XoXzu63nIHjCWuI8a1Z --tenant c86959ed-45e5-47f5-8ef5-308ca79916fc
    cd $(Agent.BuildDirectory)
  displayName: 'Azure Login'

- powershell: |
    $TESTIMG = $env:TESTIMG -replace '"', ''
    $ISSUE = $env:ISSUE -replace '"', ''
    $TEST = $env:TEST -replace '"', ''
    
    echo "TESTIMG: $env:TESTIMG"
    echo "ISSUE: $env:ISSUE"
    echo "TEST: $env:TEST"

    $dkns = "dkns01"

    $dknsIP = "20.196.215.90"

    echo "공인IP $dknsIP"

    $ISSUEDKNS = $ISSUE -replace '-', ''
    $TESTIMGDKNS = $TESTIMG -replace 'CLOUD', 'DKNS' -replace '\.img$', ''

    echo "DKNS SITE: $ISSUEDKNS"
    echo "DKNS IMG: $TESTIMGDKNS"

    ssh -i $(Build.SourcesDirectory)/start/DKNS.pem username@$dknsIP "sudo sed -i 's#^DKNS_SERVER=.*#DKNS_SERVER=$ISSUEDKNS.demo.genians.co.kr#; s#^DKNS_IMAGE=.*#DKNS_IMAGE=genians/genian-nac6-ns-beta:$TESTIMGDKNS#' /usr/geni/conf/genian2.conf"

  displayName: 'Azure Start VM/Run Test(PsExec)'
  workingDirectory: $(Build.SourcesDirectory)/start
